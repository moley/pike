
buildscript {
    repositories {
//        jcenter()
	maven { url "http://repo1.maven.org/maven2" }
    }

 /**   dependencies {
       classpath 'org.gradle.api.plugins:gradle-vagrant-plugin:0.2'
    }**/
}
/**
apply {
   plugin 'vagrant'
}
**/
allprojects {

    version=0.1

    group = 'org.pike'

    apply {
        plugin 'groovy'
        plugin 'idea'
        plugin 'eclipse'
        plugin 'jacoco'
    }

//Only workaround
    uploadArchives {
        repositories {
            ivy {
                credentials {
                    username "deployment"
                    password "deployment123"
                }
                url "http://nexus.intra.vsa.de:8081/nexus/content/repositories/gradleplugins"
            }
        }
    }

    repositories {
      mavenCentral()
      maven {
        url "http://mvnrepository.com/artifact/"
      }
    }


    dependencies {
        compile localGroovy()
        compile gradleApi()
    }

    gradle.taskGraph.whenReady { taskGraph ->
        tasks.withType(Test).each { Test test ->
            test.ignoreFailures = true
        }
    }

    // Tests in package integration are only called in task integrationtest
    test {
        exclude "**/integration/**"
    }

    task integrationtest(type: Test) {
        include "**/integration/**"
        jvmArgs "-XX:MaxPermSize=128m"
    }

}




//Because the test projects can't be subprohects (because you can test them isolated anymore) we must
//call the creation of the IDE files by hand

def subs = [];
project.subprojects.each {
    subs.add(':' + it.name + ':jar');
}

def testprojects = [];
for (File f : projectDir.listFiles()) {
    if (f.name.startsWith("testproject") && f.isDirectory()) {
        testprojects.add(f.name)
    }
}


def testIdeaTasks = []
testprojects.each {
    String testDir = it;

    def newTaskIdea = tasks.add(name: "idea" + testDir, type: GradleBuild) {
        dir = testDir
        tasks = ['cleanIdea', 'ideaModule']
    }
    testIdeaTasks.add(newTaskIdea)
}




tasks.ideaProject.dependsOn(testIdeaTasks)
tasks.ideaProject.dependsOn("cleanIdeaProject");

idea {
    project {
        ipr {
            withXml {
                //We have to put in the testprojects by hand, because we can't them inject otherwise
                Node node = it.asNode()
                node.children().each {
                    if (it.attribute("name") == "ProjectModuleManager") {
                        for (String s : testprojects) {
                            String filepath = '$PROJECT_DIR$/' + s + "/" + s + ".iml"
                            it.children()[0].appendNode("module", [fileurl: 'file://' + filepath, filepath: filepath])
                        }

                    }
                }
                //Attaches the CVS support to the projecr
                it.node.component.find { it.@name == 'VcsDirectoryMappings' }.mapping.@vcs = "CVS"
            }
        }
    }

}

jacocoTestReport {
    reports {
        xml.enabled false
        csv.enabled false
        html.destination "${buildDir}/jacocoHtml"
    }
}


